<!-- Card individual de empréstimo: exibe resumo, progresso e ações -->
@let atraso = calc.calcularDetalhesAtraso(emprestimo);

<div class="bg-white rounded-xl p-6 flex flex-col justify-between space-y-4 transition-transform hover:scale-[1.02] border cursor-pointer shadow-sm hover:shadow-md"
    [class]="atraso.diasAtraso > 0 ? 'border-red-100 ring-1 ring-red-100' : 'border-slate-200'"
    (click)="verDetalhes.emit(emprestimo)">

    <div class="flex-grow">
        <div class="flex justify-between items-start">
            <!-- Botão do nome do devedor: navega para o perfil -->
            <button (click)="verDevedor.emit(emprestimo.borrowerName); $event.stopPropagation()"
                class="text-xl font-bold text-left bg-slate-100 border border-slate-200 hover:bg-slate-200 px-3 py-1 -ml-3 rounded-lg transition-colors focus:outline-none text-slate-900 shadow-sm">
                {{ emprestimo.borrowerName }}
            </button>

            <!-- Badge de status: ATRASADO ou taxa de juros + tipo -->
            @if (atraso.diasAtraso > 0) {
            <span
                class="text-xs font-semibold bg-red-100 text-red-700 px-2 py-1 rounded-full animate-pulse">ATRASADO</span>
            } @else {
            <span class="text-xs font-mono bg-slate-100 text-slate-600 px-2 py-1 rounded">
                {{ emprestimo.interestRate }}% · {{ emprestimo.tipoJuros === 'simples' ? 'Simples' : 'Price' }}
            </span>
            }
        </div>

        <p class="text-sm text-slate-500 mb-4 mt-1">
            Vence em {{ calc.calcularDataVencimentoFinal(emprestimo) | date:'dd/MM/yyyy' }}
        </p>

        <div class="space-y-3">
            <!-- Valor da parcela mensal -->
            <div class="flex justify-between items-baseline p-3 bg-slate-50 rounded-lg border border-slate-100">
                <span class="text-slate-500 text-sm">Parcela Mensal</span>
                <span class="font-bold text-xl text-blue-600">{{ calc.calcularParcelaMensal(emprestimo) | currency:'BRL'
                    }}</span>
            </div>

            <!-- Bloco de atraso com multa (exibido apenas se atrasado) -->
            @if (atraso.diasAtraso > 0) {
            <div class="flex justify-between items-end p-3 bg-red-50 border border-red-100 rounded-lg text-sm">
                <div>
                    <p class="font-semibold text-red-700">PAGAMENTO ATRASADO</p>
                    <p class="text-xs text-red-500">{{ atraso.diasAtraso }} dia(s) de atraso</p>
                </div>
                <div class="text-right">
                    <p class="text-red-500 text-xs">+ {{ atraso.multa | currency:'BRL' }} (Juros)</p>
                    <p class="font-bold text-lg text-red-700">{{ atraso.totalDevido | currency:'BRL' }} (Total)</p>
                </div>
            </div>
            }
        </div>

        <!-- Valores resumidos: principal, recebido e saldo restante -->
        <div class="pt-4 mt-4 border-t border-slate-100 space-y-2">
            <div class="flex justify-between text-sm">
                <span class="text-slate-500">Valor Emprestado</span>
                <span class="font-semibold text-slate-900">{{ emprestimo.principal | currency:'BRL' }}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-slate-500">Valor Recebido</span>
                <span class="font-semibold text-green-600">{{ calc.calcularTotalPago(emprestimo) | currency:'BRL'
                    }}</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-slate-500">Valor a Receber</span>
                <span class="font-semibold text-yellow-600">{{ calc.calcularSaldoDevedor(emprestimo) | currency:'BRL'
                    }}</span>
            </div>
        </div>
    </div>

    <!-- Barra de progresso de parcelas -->
    <div class="pt-4 border-t" [class]="atraso.diasAtraso > 0 ? 'border-red-100' : 'border-slate-100'">
        <div class="flex justify-between items-center mb-2 text-sm">
            <span class="text-slate-500">Progresso de Parcelas</span>
            <span class="font-medium bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-xs">
                {{ calc.calcularParcelasPagas(emprestimo) }} / {{ emprestimo.paymentTermInMonths }}
            </span>
        </div>
        <div class="w-full bg-slate-100 rounded-full h-2.5">
            <div class="h-2.5 rounded-full" [class]="atraso.diasAtraso > 0 ? 'bg-yellow-500' : 'bg-green-500'"
                [style.width.%]="calc.calcularProgressoParcelas(emprestimo)"></div>
        </div>
    </div>

    <!-- Botão de ação: Registrar Pagamento ou Quitado -->
    @if(!calc.estaQuitado(emprestimo)) {
    <button (click)="registrarPagamento.emit(emprestimo); $event.stopPropagation()"
        class="w-full mt-4 bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 font-semibold py-2 rounded-lg transition-colors duration-300">
        Registrar Pagamento
    </button>
    } @else {
    <div
        class="w-full mt-4 text-center py-2 rounded-lg bg-green-50 text-green-700 font-semibold border border-green-100">
        Empréstimo Quitado
    </div>
    }
</div>